name: Update Sound Generator

on:
  schedule:
    - cron: "0 0 * * *" # Every day at midnight UTC
  workflow_dispatch:

jobs:
  update_sounds:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyttsx3 soundfile numpy

      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Download and install Ollama
        run: |
          # Download Ollama tarball
          curl -L https://github.com/ollama/ollama/releases/download/v0.11.4/ollama-linux-amd64.tgz -o ollama.tgz
          # Verify SHA256 checksum
          echo "a388afb2ccf4e61a3d0de88f0d0600e9e1d67e56bbc9a011ee287f62780bee33  ollama.tgz" | sha256sum -c -
          # Extract tarball
          tar -xzf ollama.tgz
          # Make the binary executable
          chmod +x ollama-linux-amd64/bin/ollama
          # Move to system PATH
          sudo mv ollama-linux-amd64/bin/ollama /usr/local/bin/

      - name: Pull Deepseek R1 model
        run: ollama pull deepseek-r1

      - name: Start Ollama server
        run: |
          nohup ollama serve > ollama.log 2>&1 &
          sleep 20
          curl -s http://localhost:11434/api/version || (echo "Ollama did not start!" && cat ollama.log && exit 1)

      - name: Generate Deepseek R1 prompt
        run: |
          sed "s|<insert generator.py contents here>|$(cat generator.py)|" deepseek_prompt.txt > prompt_final.txt

      - name: Call Deepseek R1 to update code
        run: |
          RESPONSE=$(curl -s -X POST http://localhost:11434/api/chat \
            -H "Content-Type: application/json" \
            -d '{
              "model": "deepseek-r1",
              "messages": [
                {"role": "system", "content": "You are an expert Python developer."},
                {"role": "user", "content": '"$(jq -Rs . < prompt_final.txt)"'}
              ]
            }')
          echo "$RESPONSE" | jq -r '.message.content' > generator.py

      - name: Run updated Python script to generate sounds
        run: python generator.py

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add generator.py sounds/
          git commit -m "Auto-update sounds and code via Deepseek R1" || echo "No changes to commit"
          git push

      - name: Print Ollama logs (always)
        if: always()
        run: cat ollama.log || echo "No Ollama logs found"
